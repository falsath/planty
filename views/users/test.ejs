<%- include('../userLayouts/userhead.ejs') %>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.9/dist/sweetalert2.all.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.1.9/dist/sweetalert2.min.css">


    <style>
        body {
            background: #f5f5f5;
            margin-top: 20px;
        }

        .ui-w-80 {
            width: 80px !important;
            height: auto;
        }

        .btn-default {
            border-color: rgba(24, 28, 33, 0.1);
            background: rgba(0, 0, 0, 0);
            color: #4E5155;
        }

        label.btn {
            margin-bottom: 0;
        }

        .btn-outline-primary {
            border-color: #26B4FF;
            background: transparent;
            color: #26B4FF;
        }

        .btn {
            cursor: pointer;
        }

        .text-light {
            color: #8c949c !important;
        }

        .btn-facebook {
            border-color: rgba(0, 0, 0, 0);
            background: #3B5998;
            color: #fff;
        }

        .btn-instagram {
            border-color: rgba(0, 0, 0, 0);
            background: #000;
            color: #fff;
        }

        .card {
            background-clip: padding-box;
            box-shadow: 0 1px 4px rgba(24, 28, 33, 0.012);
        }

        .row-bordered {
            overflow: hidden;
        }

        .account-settings-fileinput {
            position: absolute;
            visibility: hidden;
            width: 1px;
            height: 1px;
            opacity: 0;
        }

        .account-settings-links .list-group-item.active {
            font-weight: bold !important;
        }

        html:not(.dark-style) .account-settings-links .list-group-item.active {
            background: transparent !important;
        }

        .account-settings-multiselect~.select2-container {
            width: 100% !important;
        }

        .light-style .account-settings-links .list-group-item {
            padding: 0.85rem 1.5rem;
            border-color: rgba(24, 28, 33, 0.03) !important;
        }

        .light-style .account-settings-links .list-group-item.active {
            color: #4e5155 !important;
        }

        .material-style .account-settings-links .list-group-item {
            padding: 0.85rem 1.5rem;
            border-color: rgba(24, 28, 33, 0.03) !important;
        }

        .material-style .account-settings-links .list-group-item.active {
            color: #4e5155 !important;
        }

        .dark-style .account-settings-links .list-group-item {
            padding: 0.85rem 1.5rem;
            border-color: rgba(255, 255, 255, 0.03) !important;
        }

        .dark-style .account-settings-links .list-group-item.active {
            color: #fff !important;
        }

        .light-style .account-settings-links .list-group-item.active {
            color: #4E5155 !important;
        }

        .light-style .account-settings-links .list-group-item {
            padding: 0.85rem 1.5rem;
            border-color: rgba(24, 28, 33, 0.03) !important;
        }
    </style>

    
<div class="mt-5 ms-5">
    <a href="/home" class="btn btn-dark">BACK TO HOME</a>
</div>

   <div class="container light-style flex-grow-1 container-p-y">
        <h4 class="font-weight-bold py-3 mb-4">

        </h4>
        <div class="card overflow-hidden">
            <div class="row no-gutters row-bordered row-border-light">
                <div class="col-md-3 pt-0">
                    <div class="list-group list-group-flush account-settings-links">
                        <a class="list-group-item list-group-item-action active" data-toggle="list"
                            href="#account-general">My Account</a>
                        <a class="list-group-item list-group-item-action" data-toggle="list"
                            href="#account-change-password">Change password</a>
                        <a class="list-group-item list-group-item-action" data-toggle="list"
                            href="#account-Address">Address</a>
                        <a class="list-group-item list-group-item-action" data-toggle="list" href="#account-order">Order
                            Status</a>
                    </div>
                </div>


                <div class="col-md-9">
                    <div class="tab-content">

                        <div class="tab-pane fade active show" id="account-general">
                            <hr class="border-light m-0">
                            <div class="card-body">
                                <form action="" method="post">
                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label ">Username</label>
                                        <div class="col-sm-10">
                                            <p class="form-control">
                                                <%= user.username %>
                                            </p>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">Referral Code</label>
                                        <div class="col-sm-10">
                                            <% if (user.referalCode) { %>
                                                <p class="form-control">
                                                    <%= user.referalCode %>
                                                </p>
                                                <% } else { %>
                                                    <p class="form-control">No referral code available</p>
                                                    <% } %>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">Fullname</label>
                                        <div class="col-sm-10">
                                            <p class="form-control">
                                                <%= user.name %>
                                            </p>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">Mobile N0</label>
                                        <div class="col-sm-10">
                                            <p class="form-control">
                                                <%= user.mobile %>
                                            </p>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">DOB</label>
                                        <div class="col-sm-10">
                                            <p class="form-control">
                                                <%= user.dob %>
                                            </p>
                                        </div>
                                    </div>

                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">Address</label>
                                        <div class="col-sm-10">
                                            <% if (user.addresses && user.addresses.length> 0) { %>
                                                <p class="form-control">
                                                    <%= user.addresses[0].address %>
                                                </p>
                                                <% } else { %>
                                                    <p class="form-control">No address available</p>
                                                    <% } %>
                                        </div>
                                    </div>




                                    <div class="form-group row">
                                        <label class="col-sm-2 col-form-label">E-mail</label>
                                        <div class="col-sm-10">
                                            <p class="form-control">
                                                <%= user.email %>
                                            </p>
                                        </div>
                                    </div>
                            </div>
                            <div class="text-right mt-3 pt-2 pb-5 pr-3">
                                <a href="/edit-user?id=<%= user._id %>" class="btn btn-primary"
                                    id="editProfileBtn">Edit</a>
                            </div>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="account-change-password">
                            <div class="card-body pb-2">
                                <form id="password-change-form" action="" method="post">
                                    <div class="form-group">
                                        <label class="form-label">Current password</label>
                                        <input type="password" class="form-control" id="currentPassword">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">New password</label>
                                        <input type="password" class="form-control" id="newPassword">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Repeat new password</label>
                                        <input type="password" class="form-control" id="repeatPassword">
                                    </div>
                                    <div class="text-right mt-3 pt-2 pb-5 pr-3">
                                        <button type="button" class="btn btn-primary"
                                            onclick="submitForm()">SUBMIT</button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="account-Address">
                            <div class="card-body pb-2">
                                <div class="form-group row">
                                    <label class="col-sm-2 col-form-label">Addresses</label>
                                    <div class="col-sm-10">
                                        <div class="row">
                                            <% if (user.addresses && user.addresses.length > 0) { %>
                                                <% user.addresses.forEach(address => { %>
                                                    <div class="col-sm-4 mb-3">
                                                        <div class="card position-relative">
                                                            <div class="card-body">
                                                                <!-- Address details -->
                                                                <div>
                                                                    <div class="card-text">
                                                                        <%= address.address %>
                                                                        <%= address.city %>
                                                                        <%= address.state %>
                                                                        <%= address.pincode %>
                                                                        <%= address.country %>
                                                                        <%= address.phoneNumber %>
                                                                    </div>
                                                                </div>
                                                                <div class="mt-3">
                                                                    <div class="position-absolute bottom-0 end-0 mb-2 me-2">
                                                                        <a href="/editAddress?id=<%= user._id %>&addressId=<%= address._id %>">
                                                                            <button type="button" class="btn btn-sm">
                                                                                <img src="/public/photo/edit.png" style="height: 20px; width: 20px;">
                                                                            </button>
                                                                        </a>
                                                                        <a href="#" onclick="deleteAddress('<%= user._id %>', '<%= address._id %>')">
                                                                            <button type="button" class="btn btn-sm">
                                                                                <img src="/public/photo/delete.png" style="height: 20px; width: 20px;">
                                                                            </button>
                                                                        </a>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                <% }); %>
                                            <% } else { %>
                                                <div class="col-12">
                                                    <p>No addresses found. Please add an address.</p>
                                                </div>
                                            <% } %>
                                        </div>
                                        
                                    </div>
                                </div>



                                <div class="form-group row">
                                    <label class="col-sm-2 col-form-label">Add New Address</label>
                                    <div class="col-sm-10">
                                        <button type="button" class="btn btn-primary" data-toggle="modal"
                                            data-target="#addAddressModal">Add Address</button>
                                    </div>

                                </div>
                                <div class="modal" id="addAddressModal" tabindex="-1" role="dialog"
                                    aria-labelledby="addAddressModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="addAddressModalLabel">Add New Address
                                                </h5>
                                                <button type="button" class="close" data-dismiss="modal"
                                                    aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">

                                                <form action="/add-address" method="post">
                                                    <div class="form-group row">

                                                        <label for="newAddress">New Address:</label>
                                                        <input type="text" id="newAddress" name="newAddress"
                                                            class="form-control" required>

                                                        <label for="city">City:</label>
                                                        <input type="text" id="city" name="city" class="form-control"
                                                            required>

                                                        <label for="state">State:</label>
                                                        <input type="text" id="state" name="state" class="form-control"
                                                            required>

                                                        <label for="zipCode">PinCode:</label>
                                                        <input type="text" id="pincode" name="pincode"
                                                            class="form-control" required>

                                                        <label for="country">Country:</label>
                                                        <input type="text" id="country" name="country"
                                                            class="form-control" required>

                                                        <label for="phoneNumber">Phone Number:</label>
                                                        <input type="text" id="phoneNumber" name="phoneNumber"
                                                            class="form-control" required>

                                                        <br><br>

                                                        <button type="button" class="btn btn-primary"
                                                            onclick="addAddress()">Add
                                                            Address</button>
                                                    </div>


                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="account-order">
                            <section class="h-100 gradient-custom">
                                <div class="container py-5 h-100">
                                    <div class="row d-flex justify-content-center align-items-center h-100">
                                        <div class="col-md-8">
                                            <% if (orderDetails) { %>
                                                <% orderDetails.forEach((order, index)=> { %>
                                                    <div class="order-details-container bg-light rounded p-4 mb-4">
                                                        <div
                                                            class="d-flex justify-content-between align-items-center mb-3">
                                                            <h5 class="fw-bold text-primary">Order Details - <%= index +
                                                                    1 %>
                                                            </h5>
                                                            <p class="text-dark fw-bold">Total: Rs.<%= order.totalPrice
                                                                    !==undefined ? order.totalPrice.toFixed(2) : 'N/A'
                                                                    %>
                                                            </p>
                                                        </div>
                                                        <% order.products.forEach((product, productIndex)=> { %>
                                                            <div class="card shadow-0 border mb-3">
                                                                <div class="card-body p-3">
                                                                    <div class="row align-items-center">
                                                                        <div class="row align-items-center">
                                                                            <div class="col-md-3">
                                                                                <img src="/public/productImage/<%= product.product && product.product.image && product.product.image[0] %>"
                                                                                    class="img-fluid rounded"
                                                                                    alt="<%= product.product && product.product.name %>">
                                                                            </div>
                                                                            <div class="col-md-3">
                                                                                <p class="mb-1">
                                                                                    <%= product.product &&
                                                                                        product.product.name ?
                                                                                        product.product.name : 'N/A' %>
                                                                                </p>
                                                                                <p class="text-muted small">Qty: <%=
                                                                                        product.quantity %>
                                                                                </p>
                                                                            </div>
                                                                            <div class="col-md-3 text-center">
                                                                                <p class="mb-0">
                                                                                    <%= order.status %>
                                                                                </p>
                                                                            </div>
                                                                            <div class="col-md-3 text-center">
                                                                                <p class="mb-0 text-success">Rs.<%=
                                                                                        product.price !==undefined ?
                                                                                        (product.price.toFixed(2) *
                                                                                        product.quantity) : 'N/A' %>
                                                                                </p>
                                                                            </div>

                                            
                                                                        </div>

                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <% }); %>
                                                                <div class="d-flex justify-content-between">
                                                                    <div class="col-md-6">
                                                                        <% if (order.status !=='Cancelled' ) { %>
                                                                            <button class="btn btn-primary"
                                                                                onclick="downloadInvoice('<%= order._id %>')">Download
                                                                                Invoice</button>
                                                                            <% } %>
                                                                    </div>
                                                                    <div class="col-md-4 text-center">
                                                                        <% if (order.status !=='Cancelled' &&
                                                                            order.status !=='Delivered' ) { %>
                                                                            <button
                                                                                id="cancelButton_<%= order._id %>"
                                                                                class="btn btn-danger btn-sm"
                                                                                onclick="cancelOrder('<%= order._id %>')">Cancel
                                                                                Order</button>
                                                                            <% } else if
                                                                                (order.status==='Cancelled' &&
                                                                                order.walletAmountRefunded) { %>
                                                                                <div class="text-muted small">

                                                                                    <p>Wallet Refund: Rs.<%=
                                                                                            order.walletAmountRefunded.toFixed(2)
                                                                                            %>
                                                                                    </p>
                                                                                </div>
                                                                                <% } else if
                                                                                    (order.status==='Cancelled'
                                                                                    ) { %>
                                                                                    <div
                                                                                        class="text-muted small">

                                                                                    </div>
                                                                                    <% } %>
                                                                    </div>
                                                                </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <p class="text-muted">No order details found.</p>
                                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </section>
                        </div>

                    </div>

                </div>
            </div>
        </div>
    </div>


    <%- include('../userLayouts/userFoot.ejs') %>
    
  
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


<script>

    async function downloadInvoice(orderId) {
        try {
            const response = await fetch(`/invoice?id=${orderId}`);
            if (!response.ok) {
                throw new Error(`Failed to download invoice: ${response.status} - ${response.statusText}`);
            }

            const blob = await response.blob();
            const url = window.URL.createObjectURL(new Blob([blob]));
            const a = document.createElement('a');
            a.href = url;
            a.download = `invoice_${orderId}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        } catch (error) {
            console.error('Error downloading invoice:', error);
        }
    }

    function cancelOrder(orderId) {
        fetch(`/cancel-order/${orderId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then(response => response.json())
            .then(data => {
                Swal.fire({
                    title: 'Order Cancelled!',
                    text: data.message,
                    icon: 'success',
                    confirmButtonText: 'OK',
                });

                const cancelButton = document.getElementById(`cancelButton_${orderId}`);
                if (cancelButton) {
                    cancelButton.setAttribute('disabled', 'true');
                    cancelButton.innerHTML = 'Cancelled';
                    // updateCancelButtonVisibility(orderId)
                }
            })
            .catch(error => {
                console.error('Error cancelling order:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'An error occurred while cancelling the order.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                });
            });
    }

    function deleteAddress(userId, addressId) {
        if (confirm('Are you sure you want to delete this address?')) {
            window.location.href = `/deleteAddress?userId=${userId}&addressId=${addressId}`;
        }
    }

    function addAddress() {
        const newAddress = document.getElementById('newAddress').value;
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;
        const pincode = document.getElementById('pincode').value;
        const country = document.getElementById('country').value;
        const phoneNumber = document.getElementById('phoneNumber').value;

        fetch('/addaddress', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                userId: '<%= user._id %>',
                name: '<%= user.name %>',
                email: '<%= user.email %>',
                newAddress: newAddress,
                city: city,
                state: state,
                pincode: pincode,
                country: country,
                phoneNumber: phoneNumber
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    function submitForm() {
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const repeatPassword = document.getElementById('repeatPassword').value;

        if (newPassword !== repeatPassword) {
            Swal.fire({
                icon: 'error',
                title: 'Passwords do not match',
            });
            return;
        }

        fetch('/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword,
            }),
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Password changed successfully!',
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message,
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred. Please try again.',
                });
            });
    }

    $(document).ready(function () {
        $('#editProfileBtn').click(function () {
            $('input').prop('disabled', false);
            $(this).text('Save Changes').unbind('click').click(function () {
                saveChanges();
            });
        });

        function saveChanges() {
            var updatedUsername = $('#usernameInput').val();
            var updatedName = $('#nameInput').val();
            var updatedMobile = $('#mobileInput').val();
            var updatedDOB = $('#dobInput').val();
            var updatedAddress = $('#addressInput').val();
            var updatedEmail = $('#emailInput').val();

            $.ajax({
                type: 'POST',
                url: '/updateUserDetails',
                data: {
                    username: updatedUsername,
                    name: updatedName,
                    mobile: updatedMobile,
                    dob: updatedDOB,
                    address: updatedAddress,
                    email: updatedEmail
                },
                success: function (response) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Changes saved successfully!',
                    });
                    console.log('Changes saved successfully');
                },
                error: function (error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error saving changes',
                        text: 'An error occurred while saving changes.',
                    });
                    console.error('Error saving changes', error);
                },
            });

            $('input').prop('disabled', true);
            $('#editProfileBtn').text('Edit Profile').unbind('click').click(function () { });
        }
    });

</script>

<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>